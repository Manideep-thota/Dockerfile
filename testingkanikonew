pipeline {
    agent any
    environment {
        DOCKER_CREDS = credentials('dockerhub')
    }
    stages {
        stage('Build and Push Docker Image') {
            steps {
                script {
                    // Create a simple Dockerfile in the workspace
                    writeFile file: 'Dockerfile', text: '''
                    FROM alpine
                    RUN echo "Hello from Kaniko!" > /hello.txt
                    '''

                    // Create a Docker config.json using Jenkins credentials
                    sh '''
                    mkdir -p $HOME/.docker
                    echo "{\"auths\":{\"https://index.docker.io/v1/\":{\"auth\":\"$(echo -n $DOCKER_CREDS_USR:$DOCKER_CREDS_PSW | base64)\"}}}" > $HOME/.docker/config.json
                    '''

                    // Build and push the Docker image
                    sh '''
                    docker build -t mydockerhubuser/testrepo:latest .
                    docker push mydockerhubuser/testrepo:latest
                    '''
                }
            }
        }
    }
}
